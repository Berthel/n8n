{
  "createdAt": "2025-08-25T07:58:11.904Z",
  "updatedAt": "2025-09-05T14:46:56.000Z",
  "id": "aLirJs2U63vBhndG",
  "name": "Translate course dynamic",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "translate-course-corrected",
        "options": {}
      },
      "id": "284f974a-706e-4f9e-b44e-d195618c6965",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -976,
        748
      ],
      "webhookId": "translate-course-corrected"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  m.id AS module_id,\n  mt_source.content AS module_content_source,\n  COALESCE(json_agg(\n    json_build_object(\n      'lesson_id', l.id,\n      'lesson_content_source', lt_source.content,\n      'position', l.position\n    )\n    ORDER BY l.position NULLS LAST, l.id\n  ) FILTER (WHERE lt_source.content IS NOT NULL), '[]'::json) AS lessons\nFROM modules m\nJOIN courses c ON c.id = m.course_id\nJOIN module_translations mt_source\n  ON mt_source.module_id = m.id AND mt_source.language_code = '{{ $json.source_language }}'\nJOIN lessons l\n  ON l.module_id = m.id\nJOIN lesson_translations lt_source\n  ON lt_source.lesson_id = l.id AND lt_source.language_code = '{{ $json.source_language }}'\nLEFT JOIN lesson_translations lt_target\n  ON lt_target.lesson_id = l.id AND lt_target.language_code = '{{ $json.target_language }}'\nWHERE c.id = '{{ $json.course_id }}'\n  AND lt_target.lesson_id IS NULL\nGROUP BY m.id, mt_source.content;",
        "options": {}
      },
      "id": "44e0d1c7-149e-4a5c-9636-35541f307690",
      "name": "Fetch Modules+Lessons (grouped)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -752,
        924
      ],
      "credentials": {
        "postgres": {
          "id": "Vw56OL1mZd8nlif7",
          "name": "Postgres staging account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  mt_source.module_id,\n  mt_source.content AS module_content_source\nFROM module_translations mt_source\nJOIN modules m ON m.id = mt_source.module_id\nJOIN courses c ON c.id = m.course_id\nLEFT JOIN module_translations mt_target\n  ON mt_target.module_id = mt_source.module_id AND mt_target.language_code = '{{ $json.target_language }}'\nWHERE mt_source.language_code = '{{ $json.source_language }}'\n  AND c.id = '{{ $json.course_id }}'\n  AND mt_target.module_id IS NULL;",
        "options": {}
      },
      "id": "d56ea45e-c54a-4c96-8096-168e98c8170c",
      "name": "Fetch Modules (missing translations)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -304,
        448
      ],
      "credentials": {
        "postgres": {
          "id": "Vw56OL1mZd8nlif7",
          "name": "Postgres staging account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Modultekst ({{ $node[\"Webhook Trigger\"].json.source_language }}):\n{{ $json.module_content_source }}\n\nOppgave: returnér KUN oversættelsen til {{ $node[\"Webhook Trigger\"].json.target_language }}.",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Du oversætter fra {{ $node[\"Webhook Trigger\"].json.source_language }} til {{ $node[\"Webhook Trigger\"].json.target_language }}. Bevar struktur, overskrifter, markdown, kodeblokke og terminologi. Ingen forkortelser eller sammenfatninger; kun trofast oversættelse i naturligt sprog."
            }
          ]
        },
        "batching": {}
      },
      "id": "6176f4c9-9d95-4d17-a0ea-9273c6d70a27",
      "name": "Translate Module",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -80,
        240
      ]
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"module_content_translated\": \"This is the translated module content\"\n}",
        "autoFix": true
      },
      "id": "e90dc74b-f11f-44a7-a871-0fdbb7aed784",
      "name": "Module Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -4,
        464
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "google/gemini-2.0-flash-exp:free",
          "mode": "list",
          "cachedResultName": "google/gemini-2.0-flash-exp:free"
        },
        "options": {
          "temperature": 0.2
        }
      },
      "id": "b26a5223-f4ad-4504-857d-900040591add",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -8,
        672
      ],
      "credentials": {
        "openAiApi": {
          "id": "wLbV0srlBMaP36mY",
          "name": "Open Router"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO module_translations (module_id, language_code, content)\nVALUES ('{{ $json.module_id }}', '{{ $node[\"Webhook Trigger\"].json.target_language }}', '{{ $json.module_content_translated }}')\nON CONFLICT (module_id, language_code)\nDO UPDATE SET content = EXCLUDED.content\nRETURNING module_id, language_code;",
        "options": {}
      },
      "id": "87d572b7-d9c5-41a4-b0af-ef1f52ddceca",
      "name": "Upsert Module Translation",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        364,
        448
      ],
      "credentials": {
        "postgres": {
          "id": "Vw56OL1mZd8nlif7",
          "name": "Postgres staging account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "lessons",
        "include": "allOtherFields",
        "options": {}
      },
      "id": "65a1b1d8-b2c2-4846-a88c-4feddd786ced",
      "name": "Split Out Lessons",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -528,
        924
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-check",
              "leftValue": "{{ $json.lesson.lesson_content_source }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9335e884-52aa-4cf3-9222-c5b57cb0a507",
      "name": "IF Lesson Content Not Empty",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        -304,
        924
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Modul (kontekst, {{ $node[\"Webhook Trigger\"].json.source_language }}):\n{{ $json.module_content_source }}\n\nLesson (input, {{ $node[\"Webhook Trigger\"].json.source_language }}):\n{{ $json.lesson.lesson_content_source }}\n\nOppgave: Returnér KUN lesson-teksten oversat til idiomatisk {{ $node[\"Webhook Trigger\"].json.target_language }}, samme struktur/markdown.",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Du oversætter fra {{ $node[\"Webhook Trigger\"].json.source_language }} til {{ $node[\"Webhook Trigger\"].json.target_language }}. Bevar struktur, markdown, kodeblokke. Tilpas terminologi konsekvent på tværs af modul og lesson. Oversæt kun lesson-teksten, men brug modulteksten som kontekst for terminologi."
            }
          ]
        },
        "batching": {}
      },
      "id": "bb82825f-4b35-40e7-8389-5da96a12eb24",
      "name": "Translate Lesson with Context",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -34,
        1048
      ]
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"lesson_content_translated\": \"This is the translated lesson content\"\n}",
        "autoFix": true
      },
      "id": "e740c955-f2b0-4765-b7aa-ecc8efe7e5d7",
      "name": "Lesson Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -42,
        1272
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO lesson_translations (lesson_id, language_code, content)\nVALUES ('{{ $json.lesson.lesson_id }}', '{{ $node[\"Webhook Trigger\"].json.target_language }}', '{{ $json.lesson_content_translated }}')\nON CONFLICT (lesson_id, language_code)\nDO UPDATE SET content = EXCLUDED.content\nRETURNING lesson_id, language_code;",
        "options": {}
      },
      "id": "ff7b633c-f568-4869-aedf-fcdc323c9748",
      "name": "Upsert Lesson Translation",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        364,
        1048
      ],
      "credentials": {
        "postgres": {
          "id": "Vw56OL1mZd8nlif7",
          "name": "Postgres staging account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "status-field",
              "name": "status",
              "value": "success",
              "type": "string"
            },
            {
              "id": "message-field",
              "name": "message",
              "value": "Translation workflow completed for course {{ $node[\"Webhook Trigger\"].json.course_id }}",
              "type": "string"
            },
            {
              "id": "modules-field",
              "name": "modules_processed",
              "value": "{{ $items().length }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "3549534d-b1df-4814-8963-7fac6be26cbc",
      "name": "Merge Results",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        588,
        800
      ]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Fetch Modules (missing translations)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Modules+Lessons (grouped)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Modules (missing translations)": {
      "main": [
        [
          {
            "node": "Translate Module",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Translate Module",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Translate Lesson with Context",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Module Output Parser",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Lesson Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Translate Module": {
      "main": [
        [
          {
            "node": "Upsert Module Translation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Module Translation": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Modules+Lessons (grouped)": {
      "main": [
        [
          {
            "node": "Split Out Lessons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Lessons": {
      "main": [
        [
          {
            "node": "IF Lesson Content Not Empty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Lesson Content Not Empty": {
      "main": [
        [
          {
            "node": "Translate Lesson with Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Translate Lesson with Context": {
      "main": [
        [
          {
            "node": "Upsert Lesson Translation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Lesson Translation": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lesson Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Translate Lesson with Context",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Module Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Translate Module",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "fcf25aa9-a23a-4386-abd6-73631e7115a9",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-08-25T07:58:11.909Z",
      "updatedAt": "2025-08-25T07:58:11.909Z",
      "role": "workflow:owner",
      "workflowId": "aLirJs2U63vBhndG",
      "projectId": "SFLNAzqJIfhKMhJx"
    }
  ],
  "tags": []
}